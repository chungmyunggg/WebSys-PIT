<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive POS System SPA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Application Structure Plan: 
        The SPA will feature a fixed left sidebar for navigation (Dashboard, Products, Orders, Reports) and a main content area that dynamically updates.
        - Dashboard: Displays key metrics (total products, today's orders & revenue), lists recent orders and low-stock products. Interaction: View-only, quick overview.
        - Products: Shows a filterable/sortable table of products. Interactions: Add new product (modal), edit existing product (modal), delete product (with confirmation).
        - Orders: Shows a filterable/sortable table of orders. Interactions: Create new order (multi-step modal including product selection, quantity input, dynamic total calculation), view order details (modal).
        - Reports: 
            - Sales Report: Date range selection, displays sales data in a table, and a bar chart for revenue trends. Interaction: Filter by date.
            - Low Stock Report: Displays a table of products below their low stock threshold. Interaction: View-only.
        User Flow: User lands on Dashboard, navigates via sidebar. Modals are used for forms to maintain SPA context.
        Why this structure: This structure provides a familiar and intuitive dashboard experience. The SPA approach with dynamic content loading enhances responsiveness. It translates the backend-focused guide into an interactive frontend experience, allowing users to explore POS functionalities without needing a backend setup.
    -->
    <!-- Visualization & Content Choices:
        - Dashboard Metrics (Total Products, Today's Orders, Today's Revenue):
            Goal: Inform (quick overview). Viz/Presentation: HTML cards. Interaction: None. Justification: Clear, immediate stats. Library/Method: HTML/Tailwind, JS.
        - Dashboard Lists (Recent Orders, Low Stock):
            Goal: Inform (timely updates). Viz/Presentation: HTML tables. Interaction: View-only. Justification: Standard list display. Library/Method: HTML/Tailwind, JS.
        - Products Table & CRUD:
            Goal: Organize & Manage. Viz/Presentation: HTML table, Modals for forms. Interaction: Add, Edit, Delete buttons. Justification: Standard CRUD interface. Library/Method: HTML/Tailwind, JS.
        - Orders Table & Create/View:
            Goal: Organize & Track. Viz/Presentation: HTML table, Modals for forms/details. Interaction: Create order (complex modal), View details. Justification: Manages order lifecycle. Library/Method: HTML/Tailwind, JS.
        - Sales Report (Table & Chart):
            Goal: Analyze. Viz/Presentation: Date filters, HTML table, Chart.js Bar Chart for revenue. Interaction: Date filtering. Justification: Visual and tabular sales analysis. Library/Method: HTML/Tailwind, JS, Chart.js.
        - Low Stock Report Table:
            Goal: Inform. Viz/Presentation: HTML table. Interaction: View-only. Justification: Clear inventory alert. Library/Method: HTML/Tailwind, JS.
    -->
    <style>
        /* Tailwind JIT might not pick up all dynamic classes, so a few base styles can be helpful */
        body {
            font-family: 'Inter', sans-serif; /* A common Tailwind-esque font */
        }
        /* Chart container styling */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px; /* Adjusted for better dashboard fit */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px; /* Max height */
        }
        @media (min-width: 768px) { /* md breakpoint */
            .chart-container {
                height: 350px;
            }
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .chart-container {
                height: 400px;
            }
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.flex { /* When shown */
            display: flex;
        }
        /* Custom scrollbar for better aesthetics if needed */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <aside class="w-64 bg-gray-800 text-white flex flex-col p-4 space-y-2">
            <h1 class="text-2xl font-semibold mb-6 px-2">POS System</h1>
            <nav>
                <a href="#" id="nav-dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 bg-gray-700">Dashboard</a>
                <a href="#" id="nav-products" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">Products</a>
                <a href="#" id="nav-orders" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">Orders</a>
                <div class="relative">
                    <button id="nav-reports-toggle" class="w-full text-left nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">Reports</button>
                    <div id="reports-submenu" class="hidden ml-4 mt-1 space-y-1">
                        <a href="#" id="nav-reports-sales" class="nav-link block py-2 px-4 rounded text-sm hover:bg-gray-700">Sales Report</a>
                        <a href="#" id="nav-reports-low-stock" class="nav-link block py-2 px-4 rounded text-sm hover:bg-gray-700">Low Stock</a>
                    </div>
                </div>
            </nav>
        </aside>

        <main class="flex-1 p-6 sm:p-8 md:p-10 overflow-y-auto">
            <div id="content-area">
                </div>
        </main>
    </div>

    <div id="modal-placeholder"></div>


<script>
    // Mock Data
    let mockData = {
        products: [
            { id: 1, name: "Laptop Pro", quantity: 15, price: 1200.00, low_stock_threshold: 5, created_at: "2023-01-10" },
            { id: 2, name: "Wireless Mouse", quantity: 3, price: 25.00, low_stock_threshold: 10, created_at: "2023-01-15" },
            { id: 3, name: "Keyboard RGB", quantity: 30, price: 75.00, low_stock_threshold: 8, created_at: "2023-02-01" },
            { id: 4, name: "27-inch Monitor", quantity: 8, price: 300.00, low_stock_threshold: 3, created_at: "2023-02-20" },
            { id: 5, name: "USB-C Hub", quantity: 50, price: 40.00, low_stock_threshold: 15, created_at: "2023-03-05" },
            { id: 6, name: "Webcam HD", quantity: 2, price: 60.00, low_stock_threshold: 5, created_at: "2023-03-10" },
        ],
        orders: [
            { id: 1, customer_name: "Alice Smith", total_amount: 1225.00, status: "completed", created_at: new Date().toISOString().split('T')[0], items: [{ product_id: 1, quantity: 1, price: 1200.00 }, { product_id: 2, quantity: 1, price: 25.00 }] },
            { id: 2, customer_name: "Bob Johnson", total_amount: 75.00, status: "pending", created_at: new Date(new Date().setDate(new Date().getDate() - 1)).toISOString().split('T')[0], items: [{ product_id: 3, quantity: 1, price: 75.00 }] },
            { id: 3, customer_name: "Carol White", total_amount: 340.00, status: "completed", created_at: new Date(new Date().setDate(new Date().getDate() - 2)).toISOString().split('T')[0], items: [{ product_id: 4, quantity: 1, price: 300.00 }, { product_id: 5, quantity: 1, price: 40.00 }] },
            { id: 4, customer_name: "David Green", total_amount: 120.00, status: "completed", created_at: new Date(new Date().setDate(new Date().getDate() - 5)).toISOString().split('T')[0], items: [{ product_id: 6, quantity: 2, price: 60.00 }] },
        ],
        // orderItems are implicitly part of orders for this mock data simplicity
    };

    let appState = {
        currentView: 'dashboard',
        editingProductId: null,
        viewingOrderId: null,
        salesReportChart: null,
    };

    const contentArea = document.getElementById('content-area');
    const modalPlaceholder = document.getElementById('modal-placeholder');

    // Utility to get product name by ID
    function getProductNameById(productId) {
        const product = mockData.products.find(p => p.id === productId);
        return product ? product.name : 'Unknown Product';
    }
    
    // Date formatting utility
    function formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    // --- Render Functions ---
    function renderDashboard() {
        const today = new Date().toISOString().split('T')[0];
        const totalProducts = mockData.products.length;
        const todayOrders = mockData.orders.filter(o => o.created_at === today);
        const todayRevenue = todayOrders.reduce((sum, order) => sum + order.total_amount, 0);
        const lowStockProducts = mockData.products.filter(p => p.quantity <= p.low_stock_threshold);
        const recentOrders = [...mockData.orders].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 5);

        contentArea.innerHTML = `
            <div class="mb-6">
                <h1 class="text-3xl font-semibold text-gray-800">Dashboard</h1>
                <p class="text-gray-600 mt-1">Welcome to your POS system. Here's a quick overview of your store's activity.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-700">Total Products</h3>
                    <p class="text-3xl font-bold text-blue-600 mt-2">${totalProducts}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-700">Today's Orders</h3>
                    <p class="text-3xl font-bold text-green-600 mt-2">${todayOrders.length}</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium text-gray-700">Today's Revenue</h3>
                    <p class="text-3xl font-bold text-purple-600 mt-2">$${todayRevenue.toFixed(2)}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Recent Orders</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${recentOrders.map(order => `
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">#${order.id}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.customer_name || 'N/A'}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">$${order.total_amount.toFixed(2)}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDate(order.created_at)}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">No recent orders.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Low Stock Products</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Threshold</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${lowStockProducts.map(product => `
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${product.name}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium ${product.quantity < product.low_stock_threshold ? 'text-red-600' : 'text-gray-700'}">${product.quantity}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${product.low_stock_threshold}</td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3" class="px-4 py-3 text-center text-gray-500">No products are low on stock.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    function renderProducts() {
        contentArea.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-semibold text-gray-800">Products</h1>
                    <p class="text-gray-600 mt-1">Manage your product inventory. Add, edit, or remove products as needed.</p>
                </div>
                <button id="btn-add-product" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">Add Product</button>
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Low Stock Threshold</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${mockData.products.map(product => `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${product.quantity}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">$${product.price.toFixed(2)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${product.low_stock_threshold}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2">
                                    <button class="btn-edit-product text-indigo-600 hover:text-indigo-900" data-id="${product.id}">Edit</button>
                                    <button class="btn-delete-product text-red-600 hover:text-red-900" data-id="${product.id}">Delete</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="5" class="px-4 py-3 text-center text-gray-500">No products found.</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('btn-add-product').addEventListener('click', () => showProductModal());
        document.querySelectorAll('.btn-edit-product').forEach(btn => btn.addEventListener('click', (e) => showProductModal(parseInt(e.target.dataset.id))));
        document.querySelectorAll('.btn-delete-product').forEach(btn => btn.addEventListener('click', (e) => deleteProduct(parseInt(e.target.dataset.id))));
    }

    function renderOrders() {
        contentArea.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-semibold text-gray-800">Orders</h1>
                    <p class="text-gray-600 mt-1">View and manage customer orders. You can create new orders here.</p>
                </div>
                <button id="btn-create-order" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150">Create Order</button>
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${[...mockData.orders].sort((a,b) => b.id - a.id).map(order => `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">#${order.id}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.customer_name || 'N/A'}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">$${order.total_amount.toFixed(2)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${order.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${order.status}
                                    </span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDate(order.created_at)}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                                    <button class="btn-view-order text-blue-600 hover:text-blue-900" data-id="${order.id}">View</button>
                                </td>
                            </tr>
                        `).join('') || '<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">No orders found.</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
        document.getElementById('btn-create-order').addEventListener('click', () => showOrderModal());
        document.querySelectorAll('.btn-view-order').forEach(btn => btn.addEventListener('click', (e) => showOrderModal(parseInt(e.target.dataset.id), true)));
    }

    function renderReportsSales() {
        const defaultEndDate = new Date().toISOString().split('T')[0];
        const defaultStartDate = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];

        contentArea.innerHTML = `
            <div class="mb-6">
                <h1 class="text-3xl font-semibold text-gray-800">Sales Report</h1>
                <p class="text-gray-600 mt-1">Analyze your sales performance over selected periods. View detailed order information and revenue trends.</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <form id="sales-report-form" class="flex flex-col sm:flex-row sm:items-end gap-4">
                    <div>
                        <label for="start_date" class="block text-sm font-medium text-gray-700">Start Date</label>
                        <input type="date" id="start_date" name="start_date" value="${defaultStartDate}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <div>
                        <label for="end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="end_date" name="end_date" value="${defaultEndDate}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                    </div>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 h-fit">Filter</button>
                </form>
            </div>

            <div id="sales-summary" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Sales Chart</h3>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Filtered Orders</h3>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        </tr>
                    </thead>
                    <tbody id="filtered-orders-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        `;
        document.getElementById('sales-report-form').addEventListener('submit', handleSalesReportFilter);
        handleSalesReportFilter({ preventDefault: () => {} }); // Initial load
    }

    function handleSalesReportFilter(event) {
        event.preventDefault();
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;

        const filteredOrders = mockData.orders.filter(order => {
            const orderDate = order.created_at; // Already YYYY-MM-DD
            return orderDate >= startDate && orderDate <= endDate;
        });

        const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.total_amount, 0);
        const totalOrdersCount = filteredOrders.length;

        document.getElementById('sales-summary').innerHTML = `
            <div class="bg-gray-50 p-4 rounded-lg shadow">
                <h4 class="text-md font-medium text-gray-600">Total Revenue (Filtered)</h4>
                <p class="text-2xl font-bold text-green-600 mt-1">$${totalRevenue.toFixed(2)}</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg shadow">
                <h4 class="text-md font-medium text-gray-600">Total Orders (Filtered)</h4>
                <p class="text-2xl font-bold text-blue-600 mt-1">${totalOrdersCount}</p>
            </div>
        `;
        
        const tbody = document.getElementById('filtered-orders-tbody');
        tbody.innerHTML = filteredOrders.map(order => `
            <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">#${order.id}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${order.customer_name || 'N/A'}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">$${order.total_amount.toFixed(2)}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${formatDate(order.created_at)}</td>
            </tr>
        `).join('') || '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">No orders found for this period.</td></tr>';

        // Chart Data
        const salesByDate = {};
        filteredOrders.forEach(order => {
            const date = order.created_at;
            salesByDate[date] = (salesByDate[date] || 0) + order.total_amount;
        });

        const chartLabels = Object.keys(salesByDate).sort();
        const chartDataPoints = chartLabels.map(date => salesByDate[date]);

        if (appState.salesReportChart) {
            appState.salesReportChart.destroy();
        }
        const ctx = document.getElementById('salesChart').getContext('2d');
        appState.salesReportChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels.map(date => formatDate(date)), // Format date for display
                datasets: [{
                    label: 'Revenue per Day',
                    data: chartDataPoints,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)', // Blue
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) { return '$' + value; }
                        }
                    },
                    x: {
                         ticks: {
                            maxRotation: 45,
                            minRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 15, // Adjust for density
                            callback: function(value, index, values) {
                                const label = this.getLabelForValue(value); // Chart.js v3+
                                if (typeof label === 'string' && label.length > 10) { // Shorten long date labels if necessary
                                    return label.substring(0,10) + "..";
                                }
                                return label;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Revenue: $${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    }


    function renderReportsLowStock() {
        const lowStockProducts = mockData.products.filter(p => p.quantity <= p.low_stock_threshold);
        contentArea.innerHTML = `
            <div class="mb-6">
                <h1 class="text-3xl font-semibold text-gray-800">Low Stock Report</h1>
                <p class="text-gray-600 mt-1">Review products that are currently low on stock based on their defined thresholds. This helps in timely inventory replenishment.</p>
            </div>
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Quantity</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Low Stock Threshold</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Difference</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${lowStockProducts.map(product => `
                            <tr>
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-red-600 font-semibold">${product.quantity}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">${product.low_stock_threshold}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-red-600 font-semibold">${product.quantity - product.low_stock_threshold}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="4" class="px-4 py-3 text-center text-gray-500">All products are sufficiently stocked.</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
    }

    // --- Modal Functions ---
    function showProductModal(productId = null) {
        appState.editingProductId = productId;
        const product = productId ? mockData.products.find(p => p.id === productId) : null;
        const modalTitle = product ? 'Edit Product' : 'Add New Product';

        modalPlaceholder.innerHTML = `
            <div id="product-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-md transform transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">${modalTitle}</h2>
                        <button id="close-product-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                    <form id="product-form">
                        <div class="mb-4">
                            <label for="product-name" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="product-name" name="name" value="${product ? product.name : ''}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="product-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="number" id="product-quantity" name="quantity" value="${product ? product.quantity : '0'}" required min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                            <div>
                                <label for="product-price" class="block text-sm font-medium text-gray-700">Price ($)</label>
                                <input type="number" id="product-price" name="price" value="${product ? product.price.toFixed(2) : '0.00'}" required min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </div>
                        </div>
                        <div class="mb-6">
                            <label for="product-low-stock" class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                            <input type="number" id="product-low-stock" name="low_stock_threshold" value="${product ? product.low_stock_threshold : '10'}" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-product-modal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-lg">${product ? 'Save Changes' : 'Add Product'}</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.getElementById('product-modal').classList.add('flex');
        document.getElementById('close-product-modal').addEventListener('click', closeProductModal);
        document.getElementById('cancel-product-modal').addEventListener('click', closeProductModal);
        document.getElementById('product-form').addEventListener('submit', saveProduct);
    }

    function closeProductModal() {
        document.getElementById('product-modal').classList.remove('flex');
        modalPlaceholder.innerHTML = '';
        appState.editingProductId = null;
    }

    function saveProduct(event) {
        event.preventDefault();
        const form = event.target;
        const productData = {
            name: form.name.value,
            quantity: parseInt(form.quantity.value),
            price: parseFloat(form.price.value),
            low_stock_threshold: parseInt(form.low_stock_threshold.value) || 0,
        };

        if (appState.editingProductId) {
            const index = mockData.products.findIndex(p => p.id === appState.editingProductId);
            mockData.products[index] = { ...mockData.products[index], ...productData };
        } else {
            productData.id = mockData.products.length > 0 ? Math.max(...mockData.products.map(p => p.id)) + 1 : 1;
            productData.created_at = new Date().toISOString().split('T')[0];
            mockData.products.push(productData);
        }
        closeProductModal();
        renderProducts();
        if (appState.currentView === 'dashboard') renderDashboard(); // Update dashboard if visible
    }

    function deleteProduct(productId) {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
            mockData.products = mockData.products.filter(p => p.id !== productId);
            // Also consider implications for orders if product is deleted (e.g., prevent deletion if in orders, or handle gracefully)
            // For this mock, we'll just remove it.
            renderProducts();
            if (appState.currentView === 'dashboard') renderDashboard();
        }
    }
    
    let currentOrderItems = []; // For create order modal

    function showOrderModal(orderId = null, viewOnly = false) {
        appState.viewingOrderId = orderId;
        const order = orderId ? mockData.orders.find(o => o.id === orderId) : null;
        const modalTitle = viewOnly ? `View Order #${orderId}` : (order ? 'Edit Order' : 'Create New Order'); // Edit not fully implemented here
        currentOrderItems = order && !viewOnly ? [...order.items] : (order && viewOnly ? [...order.items] : []);


        let productsOptions = mockData.products.filter(p => p.quantity > 0).map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.quantity}">${p.name} (Stock: ${p.quantity})</option>`).join('');

        modalPlaceholder.innerHTML = `
            <div id="order-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4">
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-xl w-full max-w-lg transform transition-all">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800">${modalTitle}</h2>
                        <button id="close-order-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                    </div>
                    ${viewOnly ? `
                        <div>
                            <p class="mb-2"><strong class="text-gray-700">Customer:</strong> ${order.customer_name || 'N/A'}</p>
                            <p class="mb-2"><strong class="text-gray-700">Date:</strong> ${formatDate(order.created_at)}</p>
                            <p class="mb-2"><strong class="text-gray-700">Status:</strong> <span class="capitalize px-2 py-0.5 text-xs rounded-full ${order.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.status}</span></p>
                            <h4 class="text-md font-semibold mt-4 mb-2 text-gray-700">Items:</h4>
                            <ul class="list-disc list-inside space-y-1 max-h-60 overflow-y-auto border p-3 rounded-md bg-gray-50">
                                ${order.items.map(item => `<li>${getProductNameById(item.product_id)} - Qty: ${item.quantity} @ $${item.price.toFixed(2)} each</li>`).join('')}
                            </ul>
                            <p class="text-xl font-bold mt-4 text-right text-gray-800">Total: $${order.total_amount.toFixed(2)}</p>
                             <div class="flex justify-end mt-6">
                                <button type="button" id="cancel-order-modal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Close</button>
                            </div>
                        </div>
                    ` : `
                    <form id="order-form">
                        <div class="mb-4">
                            <label for="order-customer-name" class="block text-sm font-medium text-gray-700">Customer Name (Optional)</label>
                            <input type="text" id="order-customer-name" name="customer_name" value="${order ? order.customer_name : ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        
                        <div class="border p-4 rounded-md mb-4 bg-gray-50">
                            <h4 class="text-md font-semibold mb-2 text-gray-700">Add Product to Order</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                                <div class="sm:col-span-2">
                                    <label for="order-product-select" class="block text-sm font-medium text-gray-700">Product</label>
                                    <select id="order-product-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                        <option value="">Select a product</option>
                                        ${productsOptions}
                                    </select>
                                </div>
                                <div>
                                    <label for="order-product-quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                                    <input type="number" id="order-product-quantity" min="1" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </div>
                            </div>
                            <button type="button" id="btn-add-item-to-order" class="mt-3 w-full sm:w-auto bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Add Item</button>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-md font-semibold mb-2 text-gray-700">Order Items</h4>
                            <div id="current-order-items-list" class="space-y-2 max-h-48 overflow-y-auto border p-3 rounded-md bg-gray-50 min-h-[50px]">
                                ${currentOrderItems.length === 0 ? '<p class="text-sm text-gray-500">No items added yet.</p>' : ''}
                            </div>
                        </div>
                        
                        <div class="text-right mb-6">
                            <p class="text-xl font-bold text-gray-800">Total: $<span id="order-total-amount">0.00</span></p>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" id="cancel-order-modal" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg">Create Order</button>
                        </div>
                    </form>
                    `}
                </div>
            </div>
        `;
        document.getElementById('order-modal').classList.add('flex');
        document.getElementById('close-order-modal').addEventListener('click', closeOrderModal);
        document.getElementById('cancel-order-modal').addEventListener('click', closeOrderModal);

        if (!viewOnly) {
            document.getElementById('btn-add-item-to-order').addEventListener('click', addItemToCurrentOrder);
            document.getElementById('order-form').addEventListener('submit', saveOrder);
            renderCurrentOrderItems(); // Initial render for edit mode (not fully supported)
        }
    }
    
    function addItemToCurrentOrder() {
        const productId = parseInt(document.getElementById('order-product-select').value);
        const quantity = parseInt(document.getElementById('order-product-quantity').value);
        const productElement = document.getElementById('order-product-select').selectedOptions[0];

        if (!productId || !productElement) {
            alert('Please select a product.');
            return;
        }
        if (isNaN(quantity) || quantity < 1) {
            alert('Please enter a valid quantity.');
            return;
        }

        const product = mockData.products.find(p => p.id === productId);
        if (quantity > product.quantity) {
            alert(`Insufficient stock for ${product.name}. Available: ${product.quantity}`);
            return;
        }

        const existingItemIndex = currentOrderItems.findIndex(item => item.product_id === productId);
        if (existingItemIndex > -1) {
            // If item exists, update quantity, check stock again for total quantity
            const newTotalQuantity = currentOrderItems[existingItemIndex].quantity + quantity;
            if (newTotalQuantity > product.quantity) {
                 alert(`Insufficient stock for ${product.name}. You already have ${currentOrderItems[existingItemIndex].quantity} in order. Available: ${product.quantity}`);
                 return;
            }
            currentOrderItems[existingItemIndex].quantity = newTotalQuantity;
        } else {
            currentOrderItems.push({
                product_id: productId,
                name: product.name, // Store name for display
                quantity: quantity,
                price: product.price // Price at time of order
            });
        }
        renderCurrentOrderItems();
    }

    function renderCurrentOrderItems() {
        const listElement = document.getElementById('current-order-items-list');
        if (!listElement) return;

        if (currentOrderItems.length === 0) {
            listElement.innerHTML = '<p class="text-sm text-gray-500">No items added yet.</p>';
        } else {
            listElement.innerHTML = currentOrderItems.map((item, index) => `
                <div class="flex justify-between items-center text-sm p-2 bg-white rounded shadow-sm">
                    <div>
                        <span class="font-medium">${item.name || getProductNameById(item.product_id)}</span>
                        <span>(Qty: ${item.quantity} @ $${item.price.toFixed(2)})</span>
                    </div>
                    <button type="button" class="text-red-500 hover:text-red-700 remove-order-item-btn" data-index="${index}">&times;</button>
                </div>
            `).join('');
        }
        updateOrderTotal();

        document.querySelectorAll('.remove-order-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                currentOrderItems.splice(parseInt(e.target.dataset.index), 1);
                renderCurrentOrderItems();
            });
        });
    }

    function updateOrderTotal() {
        const total = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const totalAmountEl = document.getElementById('order-total-amount');
        if (totalAmountEl) {
            totalAmountEl.textContent = total.toFixed(2);
        }
    }

    function closeOrderModal() {
        if (document.getElementById('order-modal')) {
            document.getElementById('order-modal').classList.remove('flex');
        }
        modalPlaceholder.innerHTML = '';
        appState.viewingOrderId = null;
        currentOrderItems = []; // Reset for next time
    }

    function saveOrder(event) {
        event.preventDefault();
        if (currentOrderItems.length === 0) {
            alert('Please add at least one product to the order.');
            return;
        }

        const form = event.target;
        const totalAmount = currentOrderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        const newOrder = {
            id: mockData.orders.length > 0 ? Math.max(...mockData.orders.map(o => o.id)) + 1 : 1,
            customer_name: form.customer_name.value,
            total_amount: totalAmount,
            status: 'completed', // Default to completed for simplicity
            created_at: new Date().toISOString().split('T')[0],
            items: currentOrderItems.map(item => ({ product_id: item.product_id, quantity: item.quantity, price: item.price }))
        };

        // Update product quantities
        newOrder.items.forEach(item => {
            const productIndex = mockData.products.findIndex(p => p.id === item.product_id);
            if (productIndex > -1) {
                mockData.products[productIndex].quantity -= item.quantity;
            }
        });
        
        mockData.orders.push(newOrder);
        closeOrderModal();
        renderOrders();
        if (appState.currentView === 'dashboard') renderDashboard(); // Update dashboard
        if (appState.currentView === 'products') renderProducts(); // Update product stock display
    }


    // --- Navigation ---
    function setActiveLink(targetId) {
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('bg-gray-700', 'font-semibold'));
        document.getElementById(targetId).classList.add('bg-gray-700', 'font-semibold');
        
        // Handle reports submenu active state
        const reportsSubmenu = document.getElementById('reports-submenu');
        const reportsToggle = document.getElementById('nav-reports-toggle');
        if (targetId.startsWith('nav-reports-')) {
            reportsToggle.classList.add('bg-gray-700', 'font-semibold');
            reportsSubmenu.classList.remove('hidden');
        } else {
            reportsToggle.classList.remove('bg-gray-700', 'font-semibold');
        }
    }
    
    document.getElementById('nav-reports-toggle').addEventListener('click', () => {
        document.getElementById('reports-submenu').classList.toggle('hidden');
    });

    document.getElementById('nav-dashboard').addEventListener('click', (e) => { e.preventDefault(); appState.currentView = 'dashboard'; renderDashboard(); setActiveLink('nav-dashboard'); });
    document.getElementById('nav-products').addEventListener('click', (e) => { e.preventDefault(); appState.currentView = 'products'; renderProducts(); setActiveLink('nav-products'); });
    document.getElementById('nav-orders').addEventListener('click', (e) => { e.preventDefault(); appState.currentView = 'orders'; renderOrders(); setActiveLink('nav-orders'); });
    document.getElementById('nav-reports-sales').addEventListener('click', (e) => { e.preventDefault(); appState.currentView = 'reports-sales'; renderReportsSales(); setActiveLink('nav-reports-sales'); });
    document.getElementById('nav-reports-low-stock').addEventListener('click', (e) => { e.preventDefault(); appState.currentView = 'reports-low-stock'; renderReportsLowStock(); setActiveLink('nav-reports-low-stock'); });

    // Initial Load
    renderDashboard();

</script>
</body>
</html>
